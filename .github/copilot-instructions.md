# 重构准则 (Refactoring Rules)

- **沟通语言**：后续与用户的所有回复默认使用中文（除非用户明确要求切换语言）。

- **契约锁定**：`KnowledgeRepository` 接口是核心契约；**禁止修改既有方法签名与语义**，但允许**新增方法**以承载现代 RAG 能力（例如向量检索/重排/分页/过滤等），并在 data 层实现与适配。
- **数据流转向**：数据来源**优先**使用“读取预处理 JSON/DB”（例如 assets 的预处理产物、预置 DB、导入后的 DB）；允许“本地实时解析”作为**兜底路径**（例如用户临时导入文件、调试或缺失预处理产物时）。
- **搜索优化**：全文（词法）检索应**优先**基于 `KnowledgeEntity.contentNormalized`；同时允许并行引入现代 RAG 常用的检索链路（例如向量检索、块级检索/重排），但需保证结果仍可回溯到原始条目/块并可展示证据。
- **逻辑保留**：必须保留并适配 `domain.ai` 下的大模型调用逻辑；允许在**不改变对外行为**的前提下重构其内部实现（例如 prompt 组装、引用格式、流式输出与错误处理）。

---

# 代码约束准则（长期生效）

以下规则用于确保后续开发长期保持：模块化清晰、单一职责、Compose 可复用、文件长度可控。
所有修改默认遵守“最小改动原则”：不为重构而重构，优先低风险、小步、可回退。

## 1) 模块化与分层（domain / data / ui）

- **依赖方向**：`ui` → `domain` ← `data`（`data` 实现 `domain` 的接口；`domain` 不依赖 `ui/data` 具体实现）。
- **domain 纯净**：`domain` 层避免依赖 Android/Compose（例如 `Context`、`ViewModel`、`@Composable`），尽量只包含业务模型/用例/仓库契约/AI 相关领域逻辑。
- **data 负责数据源**：读取 JSON/DB、网络/文件/缓存、DTO/Entity 映射、Repository 实现都放在 `data`。
- **ui 只负责展示与交互**：Compose 组件、导航、状态收集、UI 映射（domain → ui model）放在 `ui`。

## 2) 单一职责（SRP）

- **一个类/文件只做一件事**：例如“状态生产”、“UI 编排”、“解析/normalize 纯逻辑”、“交互处理”等要分开。
- **优先抽纯函数/纯对象**：可测试、无副作用的 helper 优先独立为 `internal object`/`internal fun`。
- **入口保持薄**：Screen/入口函数只做编排与委托，复杂逻辑下沉到专用组件或 helper。
- **避免跨层泄露**：例如 `Context`、`NavController` 不应进入纯逻辑 helper；需要时通过参数传入最小必要信息。

## 3) Compose 组件可复用

- **组件设计**：优先无状态（state hoisting），把 `Modifier` 作为首个可选参数暴露，避免硬编码 padding/size。
- **复用优先**：多个页面共用的 Loading/Empty/Error/按钮/列表项组件应抽到可复用文件，避免复制粘贴。
- **副作用边界清晰**：`remember/LaunchedEffect/produceState` 只放在负责“状态生产”的小组件/层，不要散落在深层 UI 渲染中。

## 4) 控制文件长度（但不强制为拆而拆）

- **目标**：单文件尽量 ≤ 200 行；超过后优先考虑抽离（helpers、子组件、controller、defaults 等）。
- **保持聚焦**：拆分以“职责边界”为准，不按行数机械切割；拆完后入口更薄、依赖更少才算有效。

## 5) 安全与回归（每次改动都要可编译）

- **小步提交思维**：每次改动围绕一个明确目标，避免顺手改 unrelated。
- **不改核心契约**：`KnowledgeRepository` 既有方法签名与语义保持不变；如需扩展能力，允许新增方法并同步更新 data 层实现与注入。
- **编译回归**：每轮重构后至少跑 `:app:compileDebugKotlin`，确保 `BUILD SUCCESSFUL` 再继续下一步。


> 注：为解决详情页渲染稳定性问题，允许对 `ui` 层做必要调整（仍应保持改动最小化）。

- **契约锁定**：`KnowledgeRepository` 接口是核心契约；禁止修改既有方法签名与语义，但允许新增方法以扩展现代 RAG 能力。
- **数据流转向**：数据来源优先读取预处理 JSON/DB，允许本地实时解析作为兜底路径。
- **搜索优化**：全文（词法）检索优先使用 `KnowledgeEntity.contentNormalized`，允许并行引入向量/重排等检索链路并保留可追溯证据。
- **逻辑保留**：保留并适配 `domain.ai` 调用逻辑，允许不改对外行为的内部重构。
